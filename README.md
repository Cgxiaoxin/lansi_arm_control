# 蓝思机械臂控制系统

基于CAN总线的7轴机械臂控制系统，支持图形界面操作、零点标定、示教轨迹等功能。

## 功能特性

- ✅ **图形界面控制**: 友好的GUI界面，操作简单直观
- ✅ **零点标定**: 支持手动拖动标定零点位置
- ✅ **速度控制**: 4档速度预设 + 自定义速度/加速度参数
- ✅ **示教轨迹**: 记录多个点位并自动播放
- ✅ **安全保护**: 退出时自动回零并安全关闭
- ✅ **实时监控**: 实时显示电机位置（绝对/相对/角度）

## 系统要求

- Linux系统（支持SocketCAN）
- Python 3.6+
- CAN接口（can0）

## 安装

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置CAN接口

```bash
# 设置CAN接口（波特率1Mbps）
sudo ip link set can0 down
sudo ip link set can0 up type can bitrate 1000000

# 检查CAN接口状态
ip link show can0
```

### 3. 扫描电机ID

```bash
python3 scan_motors.py
```

确认你的机械臂电机ID（默认: 51-57）

## 使用方法

### 图形界面（推荐）

```bash
python3 arm_control_gui.py
```

**使用流程：**

1. **连接**: 点击"连接"按钮
2. **初始化**: 点击"初始化机械臂"
3. **设置速度**: 在"速度设置"标签页选择合适的速度（建议先用"慢速"）
4. **操作**: 
   - 单电机控制：在主控制页面输入目标位置
   - 零点标定：进入自由拖动 → 手动移动 → 标定零点
   - 示教轨迹：记录多个点位 → 播放轨迹

### 命令行版本

```bash
python3 arm_control.py
```

## 主要功能说明

### 1. 零点标定

1. 点击"进入自由拖动"
2. 手动将机械臂移动到目标零点位置
3. 点击"标定当前为零点"
4. 点击"退出并锁定"（电机会锁定在当前位置）

零点偏移会自动保存到 `zero_offset.json`

### 2. 速度设置

**预设速度：**
- 极慢: 0.2 rad/s（调试/标定）
- 慢速: 0.5 rad/s（安全测试）
- 中速: 1.0 rad/s（正常使用）
- 快速: 2.0 rad/s（快速运动）

**自定义速度：**
在"速度设置"标签页输入：
- 最大速度 (rad/s)
- 加速度 (rad/s²)
- 减速度 (rad/s²)

### 3. 示教轨迹

1. 将机械臂移动到目标位置
2. 输入点位名称
3. 点击"记录当前位置"
4. 重复上述步骤记录多个点
5. 点击"播放轨迹"自动执行

轨迹会自动保存到 `trajectory.json`

### 4. 安全退出

在"安全设置"标签页可以设置：
- ✅ **退出时先回到零点再关闭电机**（默认开启）
- 关闭程序时会自动执行：回到零点 → 等待3秒 → 关闭电机

## 项目文件

| 文件 | 说明 |
|------|------|
| `arm_control_gui.py` | **主程序** - 图形界面版本 |
| `arm_control.py` | 命令行版本（备用） |
| `lansi_motor_controller.py` | 核心电机控制器库 |
| `scan_motors.py` | CAN总线电机扫描工具 |
| `lansi_diagnose.py` | 诊断工具 |
| `lansi_debug_tool.py` | 交互式调试工具 |
| `config.yaml` | 配置文件 |
| `zero_offset.json` | 零点偏移（自动生成） |
| `trajectory.json` | 示教轨迹（自动生成） |

## 电机ID配置

默认电机ID: **51-57** (0x33-0x39)

如需修改，编辑 `arm_control_gui.py` 中的 `MOTOR_IDS` 变量：

```python
MOTOR_IDS = [51, 52, 53, 54, 55, 56, 57]
```

## 故障排查

### CAN接口无法连接

```bash
# 检查CAN接口状态
ip link show can0

# 重新初始化CAN接口
sudo ip link set can0 down
sudo ip link set can0 up type can bitrate 1000000

# 检查是否有错误
dmesg | grep can
```

### 电机无响应

1. 运行诊断工具：`python3 lansi_diagnose.py`
2. 检查电机ID是否正确：`python3 scan_motors.py`
3. 检查电机是否上电
4. 检查CAN线连接

### 电机运动过快

1. 在"速度设置"中选择"极慢"或"慢速"
2. 或自定义更小的速度值

## 安全注意事项

⚠️ **重要提示：**

1. **首次使用前务必设置慢速**
2. **确保机械臂周围无障碍物**
3. **零点位置必须是安全的**
4. **退出程序前确认安全退出选项已开启**
5. **紧急情况：直接拔掉电源或按紧急停止按钮**

## 开发信息

- **协议文档**: 蓝思电机文档.pdf
- **CAN波特率**: 1Mbps
- **控制模式**: 轨迹位置模式（MODE_PROFILE_POSITION）

## 许可证

本项目仅供学习和研究使用。

## 更新日志

### v1.0 (今日)
- ✅ 完成基础控制功能
- ✅ 实现图形界面
- ✅ 添加零点标定功能
- ✅ 添加速度控制功能
- ✅ 添加示教轨迹功能
- ✅ 实现安全退出保护
